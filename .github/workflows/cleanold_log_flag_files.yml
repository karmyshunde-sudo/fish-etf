name: 9-清理旧logflag
on:
  workflow_dispatch:
    inputs:
      task:
        description: '任务ID（必须是"cleanoldlog"）'
        required: true
        default: 'cleanoldlog'
        type: string

jobs:
  clean-old-flag-log-files:
    name: 清理data/flags和data/logs目录下超过15天的文件
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 验证时区设置
        run: |
          echo "时区验证: $(date -u '+%Y-%m-%d %H:%M:%S' UTC) | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S' CST)"
      
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 安装项目依赖
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "⚠️ 注意: requirements.txt 不存在，安装基本依赖"
            pip install pandas numpy akshare requests pytz
          fi

      - name: 运行清理脚本
        run: |
          # 确保在项目根目录运行脚本
          cd $GITHUB_WORKSPACE
          
          # 检查清理脚本是否存在
          if [ ! -f "data_crawler/cleanup_old_files.py" ]; then
            echo "❌ 错误: 清理脚本不存在 (data_crawler/cleanup_old_files.py)"
            exit 1
          fi
          
          # 检查config模块是否存在
          if [ ! -f "config.py" ]; then
            echo "❌ 错误: config.py 不存在，无法导入Config模块"
            exit 1
          fi
          
          # 检查工具模块
          if [ ! -f "utils/date_utils.py" ]; then
            echo "❌ 错误: utils/date_utils.py 不存在，无法获取北京时间"
            exit 1
          fi
          
          # 将项目根目录添加到PYTHONPATH
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH
          
          # 运行清理脚本
          python data_crawler/cleanup_old_files.py
          
          # 检查脚本退出码
          if [ $? -ne 0 ]; then
            echo "❌ 清理脚本执行失败"
            exit 1
          fi
