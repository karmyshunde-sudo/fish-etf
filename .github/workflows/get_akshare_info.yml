name: 6-数据源接口信息
on:
  workflow_dispatch:
    inputs:
      data_source:
        description: '选择数据源'
        required: true
        type: choice
        options:
          - 'akshare'
          - 'baostock'
      interface_name:
        description: '接口名称（留空获取全部接口）'
        required: false
        type: string
        default: ''

jobs:
  get-all-akshare-interfaces:
    name: 1. 获取全部AkShare接口
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ inputs.data_source == 'akshare' && !inputs.interface_name }}
    env:
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
    steps:
      - name: 验证时区设置
        run: |
          echo "时区验证: $(date -u '+%Y-%m-%d %H:%M:%S' UTC) | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S' CST)"

      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 配置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖包
        run: |
          echo "当前工作目录: $(pwd)"
          # 检查 requirements.txt 是否存在
          if [ -f "requirements.txt" ]; then
            echo "✅ requirements.txt 文件存在，开始安装依赖..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 验证 akshare 是否安装成功
            if ! python -c "import akshare; print('akshare 版本:', akshare.__version__)"; then
              echo "❌ akshare 未正确安装，尝试单独安装..."
              pip install akshare
            fi
            # 再次验证
            if ! python -c "import akshare"; then
              echo "❌ akshare 安装失败"
              exit 1
            fi
          else
            echo "❌ 错误: requirements.txt 文件不存在"
            ls -la
            exit 1
          fi
      
      - name: 获取全部AkShare接口
        run: |
          echo "正在获取全部AkShare接口..."
          python data_crawler/get_akshare_info.py
          
      - name: 检查文件状态（诊断）
        run: |
          echo "检查 data/flags/ 目录状态:"
          ls -la data/flags/ 2>/dev/null || echo "目录不存在"
          echo "文件内容预览:"
          head -n 3 data/flags/*.txt 2>/dev/null || echo "无标志文件或为空"
      
      - name: 发送完成通知
        if: success()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="✅ 【AkShare】已获取全部接口列表"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi
      
      - name: 发送失败通知
        if: failure()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"❌ 【AkShare】获取全部接口失败\\n北京时间: ${BEIJING_TIME}\"}}"
          fi

  get-specific-akshare-interface:
    name: 2. 获取指定AkShare接口
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ inputs.data_source == 'akshare' && inputs.interface_name }}
    env:
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
    steps:
      - name: 验证时区设置
        run: |
          echo "时区验证: $(date -u '+%Y-%m-%d %H:%M:%S' UTC) | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S' CST)"

      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 配置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖包
        run: |
          echo "当前工作目录: $(pwd)"
          # 检查 requirements.txt 是否存在
          if [ -f "requirements.txt" ]; then
            echo "✅ requirements.txt 文件存在，开始安装依赖..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 验证 akshare 是否安装成功
            if ! python -c "import akshare; print('akshare 版本:', akshare.__version__)"; then
              echo "❌ akshare 未正确安装，尝试单独安装..."
              pip install akshare
            fi
            # 再次验证
            if ! python -c "import akshare"; then
              echo "❌ akshare 安装失败"
              exit 1
            fi
          else
            echo "❌ 错误: requirements.txt 文件不存在"
            ls -la
            exit 1
          fi
      
      - name: 获取指定AkShare接口
        run: |
          INTERFACE_NAME="${{ inputs.interface_name }}"
          echo "正在查询AkShare接口: $INTERFACE_NAME"
          python data_crawler/get_akshare_info.py "$INTERFACE_NAME"
          
      - name: 检查文件状态（诊断）
        run: |
          echo "检查 data/saveapi/ 目录状态:"
          ls -la data/saveapi/ 2>/dev/null || echo "目录不存在"
      
      - name: 发送完成通知
        if: success()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="✅ 【AkShare】已查询接口: ${{ inputs.interface_name }}"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi
      
      - name: 发送失败通知
        if: failure()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="❌ 【AkShare】查询接口失败: ${{ inputs.interface_name }}"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi

  get-all-baostock-interfaces:
    name: 3. 获取全部Baostock接口
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ inputs.data_source == 'baostock' && !inputs.interface_name }}
    env:
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
    steps:
      - name: 验证时区设置
        run: |
          echo "时区验证: $(date -u '+%Y-%m-%d %H:%M:%S' UTC) | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S' CST)"

      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 配置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖包
        run: |
          echo "当前工作目录: $(pwd)"
          # 检查 requirements.txt 是否存在
          if [ -f "requirements.txt" ]; then
            echo "✅ requirements.txt 文件存在，开始安装依赖..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 验证 baostock 是否安装成功
            if ! python -c "import baostock; print('baostock 版本:', baostock.__version__)"; then
              echo "❌ baostock 未正确安装，尝试单独安装..."
              pip install baostock
            fi
            # 再次验证
            if ! python -c "import baostock"; then
              echo "❌ baostock 安装失败"
              exit 1
            fi
          else
            echo "❌ 错误: requirements.txt 文件不存在"
            ls -la
            exit 1
          fi
      
      - name: 获取全部Baostock接口
        run: |
          echo "正在获取全部Baostock接口..."
          python data_crawler/get_baostock_info.py
          
      - name: 检查文件状态（诊断）
        run: |
          echo "检查 data/flags/ 目录状态:"
          ls -la data/flags/ 2>/dev/null || echo "目录不存在"
          echo "文件内容预览:"
          head -n 3 data/flags/*.txt 2>/dev/null || echo "无标志文件或为空"
      
      - name: 发送完成通知
        if: success()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="✅ 【Baostock】已获取全部接口列表"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi
      
      - name: 发送失败通知
        if: failure()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"❌ 【Baostock】获取全部接口失败\\n北京时间: ${BEIJING_TIME}\"}}"
          fi

  get-specific-baostock-interface:
    name: 4. 获取指定Baostock接口
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ inputs.data_source == 'baostock' && inputs.interface_name }}
    env:
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
    steps:
      - name: 验证时区设置
        run: |
          echo "时区验证: $(date -u '+%Y-%m-%d %H:%M:%S' UTC) | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S' CST)"

      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 配置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: 安装依赖包
        run: |
          echo "当前工作目录: $(pwd)"
          # 检查 requirements.txt 是否存在
          if [ -f "requirements.txt" ]; then
            echo "✅ requirements.txt 文件存在，开始安装依赖..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # 验证 baostock 是否安装成功
            if ! python -c "import baostock; print('baostock 版本:', baostock.__version__)"; then
              echo "❌ baostock 未正确安装，尝试单独安装..."
              pip install baostock
            fi
            # 再次验证
            if ! python -c "import baostock"; then
              echo "❌ baostock 安装失败"
              exit 1
            fi
          else
            echo "❌ 错误: requirements.txt 文件不存在"
            ls -la
            exit 1
          fi
      
      - name: 获取指定Baostock接口
        run: |
          INTERFACE_NAME="${{ inputs.interface_name }}"
          echo "正在查询Baostock接口: $INTERFACE_NAME"
          python data_crawler/get_baostock_info.py "$INTERFACE_NAME"
          
      - name: 检查文件状态（诊断）
        run: |
          echo "检查 data/saveapi/ 目录状态:"
          ls -la data/saveapi/ 2>/dev/null || echo "目录不存在"
      
      - name: 发送完成通知
        if: success()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="✅ 【Baostock】已查询接口: ${{ inputs.interface_name }}"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi
      
      - name: 发送失败通知
        if: failure()
        run: |
          BEIJING_TIME=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          MSG="❌ 【Baostock】查询接口失败: ${{ inputs.interface_name }}"
          if [ -z "$WECOM_WEBHOOK" ]; then
            echo "⚠️ WECOM_WEBHOOK 环境变量未设置，跳过发送通知"
          else
            curl -s -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" \
              -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"$MSG\\n北京时间: ${BEIJING_TIME}\"}}"
          fi
